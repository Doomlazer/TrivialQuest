<!DOCTYPE html>
<html>
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<style type="text/css">
@font-face {
    font-family: SQ3font;
    src: url(SQ3n001.ttf);
}

* {
    font-family: SQ3font;
    font-size: 30px;
    box-sizing: border-box;
}
.butt {
    font-size: 16px;
    font-family: "arial";
}
</style>
<body onload="start()">

<canvas id="myCanvas" width="640" height="458" style="border:1px solid #d3d3d3;">
Your browser does not support the HTML5 canvas tag.</canvas>
<img id="mask" src="img/lsl3/mask.png" width="642" height="458" hidden>
<img id="background" src="img/lsl3/background.png" width="642" height="458" hidden>

<script>
var c = document.getElementById("myCanvas");
var ctx = c.getContext("2d");
//ctx.scale(2, 2);
const mask = document.getElementById("mask");
const bkgnd = document.getElementById("background");
var score = 0;
var rightAns;
var splitData;
var questionJson;
var q;
var qSpacing = 60;
var qBaseNum = 170;
var nxt = 0;
var qType = 1;
var lang = "EN";
var langLock = 0;
let r;
let ansArray = [];
let wrapLen = 28;
let prevSong = -1;
const myAudio = document.createElement("audio");

function searchForSpecialChars() {
    lang = "FR";
    let holder = [];
    for (let i = 141; i < 167; i++) {
        let s = "data/" + lang + "/lsl3/text." + i;
        console.log("Searching file: " + s);
        fetch(s)
        //.then(response => response.text())
        .then(response => response.arrayBuffer())
        .then((buffer) => {

                let decoder = new TextDecoder("iso-8859-1");
                let data = decoder.decode(buffer);
                //console.log(data);
                let x2=0;
                for (let x of data) {
                    if (data.charCodeAt(x2) > 200) {
                        //console.log("x: " + x + " charat: " + data.charCodeAt(x2));
                        let st = x+" - "+data.charCodeAt(x2).toString(16) + " - " + i;
                        if (!holder.includes(st)) {
                            holder.push(st);
                        }
                    }
                    x2 ++;
                }
                console.log(holder);
            }
        )
    }
}

function initAudio() {
    myAudio.src = "audio/0.mp3";
    myAudio.addEventListener("ended", function() {
        let r = prevSong;
        while (r == prevSong ) {
            r = Math.floor(Math.random() * 7);
        }
        myAudio.src = "audio/" + r + ".mp3";
        myAudio.play();
    });
}

function musicOnOff() {
    if (myAudio.paused) {
        myAudio.play();
    } else {
        myAudio.pause();
    }
}

function getLangStr(n) {
    let str;
    if (n == 1) { //score
        if (lang == "EN") {
            str = "Score: ".concat(score);
            return str
        } else if (lang == "FR") {
            str = "Score : ".concat(score);
            return str
        } else if (lang == "SP") {
            str = "Puntuaci\u00f3n: ".concat(score);
            return str
        } else if (lang == "GR") {
            str = "Punktzahl: ".concat(score);
            return str
        } else if (lang == "PL") {
            str = "Wynik: ".concat(score);
            return str
        }
    }
    if (n == 2) { // Correct
        if (lang == "EN") {
            str = "Correct"
            return str
        } else if (lang == "FR") {
            str = "Correct";
            return str
        } else if (lang == "SP") {
            str = "Correcto:";
            return str
        } else if (lang == "GR") {
            str = "Richtig";
            return str
        } else if (lang == "PL") {
            str = "Poprawnie";
            return str
        }

    }
    if (n == 3) { // "Wrong "
        if (lang == "EN") {
            str = "Wrong"
            return str
        } else if (lang == "FR") {
            str = "Faux";
            return str
        } else if (lang == "SP") {
            str = "Incorrecto";
            return str
        } else if (lang == "GR") {
            str = "Falsch";
            return str
        } else if (lang == "PL") {
            str = "Źle";
            return str
        }

    }
}
 

function start() {
    ctx.imageSmoothingEnabled = false;
    drawBkgnd();
    ctx.font = "30px SQ3font";
    initClick();
    nextQuestion()
}

function initClick() {
    c.addEventListener("click", getClickPosition, false);

    function getClickPosition(e) {
        if (prevSong == -1) {
            prevSong = 0;
            initAudio();
            myAudio.play();
        }

        if (nxt == 1) {
            // 2nd click triggers new question
            nxt = 0;
            nextQuestion();
        } else {
            // player selects answer
            var xPosition = e.clientX;
            var yPosition = e.clientY - 10;
            var ans = 0;

            /* testing guidelines
            for (let i=0; i<5; i++) {
                ctx.fillStyle = "Black";
                ctx.rect(290, qBaseNum+(i*qSpacing), 300, 5);
                ctx.fill(); 
            }

            //mouse
            ctx.rect(xPosition, yPosition, 10, 10);
            ctx.fill(); 
            */

            // check if clicked in an answer
            for (let i = 0; i<4; i++) {
                if (yPosition > (qBaseNum + (i*qSpacing)) && yPosition <= (qBaseNum + qSpacing + (i*qSpacing))) {
                    ans = i+2;
                    console.log("ans: "+ans);
                }
            }

            if (ans > 0) {
                let a = ans-2;
                if (ans -1 == rightAns) {
                    score ++;
                    ctx.fillStyle = "Green";
                    let str;
                    if (qType == 1) {
                        str = ansArray[a];
                    } else {
                        str = wrapText(questionJson.correct_answer, wrapLen); 
                    }
                    printText(str, 320, qBaseNum + (qSpacing/2) + (qSpacing*a));
                    //console.log("score: " + score);
                } else {
                    score --;
                    ctx.fillStyle = "Red";
                    if (qType == 1) {
                        //let s = wrapText(splitData[(q+ans)], wrapLen);
                        printText(ansArray[a], 320, qBaseNum + (qSpacing/2) + (qSpacing*a));
                    } else {
                        let b = a
                        if (b > rightAns) {
                            b --;
                        }
                        let s = wrapText(questionJson.incorrect_answers[b], wrapLen);
                        printText(s, 320, qBaseNum + (qSpacing/2) + (qSpacing*a));
                    }
                }

                ctx.fillStyle = "Yellow";
                if (ans > 0 && ans-1 == rightAns) {
                    printText(getLangStr(2),400,25); // correct
                } else {
                    printText(getLangStr(3),400,25); // wrong
                }
                // wait a click before next question
                nxt ++;
            }
        }
    }
}

function nextQuestion() {
    if (qType == 1) {
        lsl3Question();
    } else if (qType == 2) {
        otQuestion();
    }
}

function fjson(text) {
    let s = text.replaceAll("&quot;", "\"");
    s = s.replaceAll("&#039;", "'");
    s = s.replaceAll("&#amp;", "&");
    return s;
}

function otQuestion() {
    drawBkgnd();
    ctx.fillStyle = "Blue";
    printText("Fetching question...",320,120);
    fetch("https://opentdb.com/api.php?amount=1&type=multiple")
    .then(response => { return response.json(); })
    .then((data) => {
        // Work with JSON data here
        questionJson = data.results[0];
        drawBkgnd();
        ctx.fillStyle = "Yellow";
        printText(getLangStr(1),400,50); //score: 
        ctx.fillStyle = "Blue";
        let s1 = wrapText(fjson(questionJson.question), wrapLen);
        printText(s1, 320, 120);
        r = Math.floor(Math.random() * 4);
        let ia = 0;
        for (let i = 0;i<4;i++) {
            if (i == r) {
                let s = wrapText(fjson(questionJson.correct_answer), wrapLen);
                printText(s, 320, qBaseNum + (qSpacing/2) + (qSpacing*i));
                rightAns = i+1;
            } else {
                let s = wrapText(questionJson.incorrect_answers[ia], wrapLen);
                printText(s, 320, qBaseNum + (qSpacing/2) + (qSpacing*i));
                ia ++;
            }
        }
    }).catch(err => {});
}

function lsl3Question() {
    ansArray = [];
    drawBkgnd();
    ctx.fillStyle = "Yellow";
    printText(getLangStr(1),400,50); //score: 
    // load questions
    // each text file has five questions
    // files range from 141 to 166. Looks like in the game only 141-161 are used?
    let r = Math.floor(Math.random() * (166 - 141) + 141);
    //r = 153 // testing only!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    let s = "data/" + lang + "/lsl3/text.";
    s = s.concat(r);
    console.log("s: " + s);
    fetch(s)
    //.then(response => response.text())
    .then(response => response.arrayBuffer())
    .then((buffer) => {

            let decoder = new TextDecoder("iso-8859-1");
            let data = decoder.decode(buffer);
            //console.log(data);
            let trunk = data.slice(2);
            if (lang == "FR") {
                trunk = trunk.replaceAll("\u0152","\u00ee"); // Œ -> î
                trunk = trunk.replaceAll("\u0160","\u00e8"); // Š -> è
                trunk = trunk.replaceAll("\u0192","?2"); // ƒ
                trunk = trunk.replaceAll("\u02c6","\u00ea"); // ^ -> ê
                trunk = trunk.replaceAll("\u2013","\u00fb"); // — -> û
                trunk = trunk.replaceAll("\u2014","\u00f9"); // — -> ù
                trunk = trunk.replaceAll("\u201a","\u00e9"); // ‚ -> é
                trunk = trunk.replaceAll("\u201c","\u00f4"); // “ -> ô
                trunk = trunk.replaceAll("\u2021","\u00e7"); // ‡ -> ç
                trunk = trunk.replaceAll("\u2026","\u00e0"); // … -> à
                trunk = trunk.replaceAll("\u2030","\u00eb"); // ‰ -> ë
            } else if (lang == "GR") {
                trunk = trunk.replaceAll("\u00e1","?1"); // á
                trunk = trunk.replaceAll("\u0161","?2"); // š
                trunk = trunk.replaceAll("\u017d","?3"); // Ž
                trunk = trunk.replaceAll("\u0192","?4"); // ƒ
                trunk = trunk.replaceAll("\u201a","?5"); // ‚
                trunk = trunk.replaceAll("\u201d","?6"); // ”
                trunk = trunk.replaceAll("\u201e","\u00e4"); // „ -> ä
                trunk = trunk.replaceAll("\u2122","?8"); // ™
            } else if (lang == "SP") {
                trunk = trunk.replaceAll("\u0026","\u00bf"); // & -> ¿
                trunk = trunk.replaceAll("\u002b","\u00e9"); // + -> é
                trunk = trunk.replaceAll("\u007d","\u00f1"); // } -> ñ
                trunk = trunk.replaceAll("\u003e","\u00f3"); // > -> ó
                trunk = trunk.replaceAll("\u007b","\u00fa"); // { -> ú
                trunk = trunk.replaceAll("\u002a","\u00e1"); // * -> á
                trunk = trunk.replaceAll("\u007c","\u00ed"); // | -> í
                trunk = trunk.replaceAll("\u005e","\u00a1"); // ^ -> ¡
            }            
            //console.log(trunk);
            splitData = trunk.split("\x00");
            q = Math.floor(Math.random()*4)*5;
            //q = 0 // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
            console.log("q: " + q);
            //console.log(splitData[0]);
            ctx.fillStyle = "Blue";
            let temp = splitData[q].slice(1);
            let temp1 = splitData[q+1];
            let temp2 = splitData[q+2];
            let temp3 = splitData[q+3];
            let temp4 = splitData[q+4];
            // French & German patch files contain english, remove it
            if (lang == "FR") {
                let tempArray = temp.split("%F");
                temp = tempArray[1];
                let tempArray1 = temp1.split("%F");
                temp1 = tempArray1[1];
                let tempArray2 = temp2.split("%F");
                temp2 = tempArray2[1];
                let tempArray3 = temp3.split("%F");
                temp3 = tempArray3[1];
                let tempArray4 = temp4.split("%F");
                temp4 = tempArray4[1];
            } else if (lang == "GR") {
                let tempArray = temp.split("%G");
                temp = tempArray[1];
                let tempArray1 = temp1.split("%G");
                temp1 = tempArray1[1];
                let tempArray2 = temp2.split("%G");
                temp2 = tempArray2[1];
                let tempArray3 = temp3.split("%G");
                temp3 = tempArray3[1];
                let tempArray4 = temp4.split("%G");
                temp4 = tempArray4[1];
            }
            let string = wrapText(temp, wrapLen);
            //console.log(string);
            printText(string,320,120);
            rightAns = splitData[q].slice(0,1);
            ansArray.push(wrapText(temp1, wrapLen));
            ansArray.push(wrapText(temp2, wrapLen));
            ansArray.push(wrapText(temp3, wrapLen));
            ansArray.push(wrapText(temp4, wrapLen));
            let x2 = 0;
            for (let i = 0; i < 4; i ++) {
                printText(ansArray[i], 320, qBaseNum + (qSpacing/2) + (qSpacing*i));
            }
        }
    )
};

function drawBkgnd() {
    ctx.clearRect(0, 0, c.width, c.height);
    ctx.drawImage(bkgnd, 0, 0);
    // bikini, y between 120 - 200
    ctx.fillStyle = "Black";
    ctx.beginPath();
    ctx.rect(50, 120+score, 125, 125);
    ctx.fill(); 
    // overlay 
    ctx.drawImage(mask, 0, 0); 
};

function printText(text, x ,y) {
    let textArray = text.split("\n");
    ctx.fillText(textArray[0], x, y);
    if (typeof textArray[1] !== 'undefined') {
        if (textArray[0] != textArray[1]) {
            ctx.fillText(textArray[1], x, y+16);
        }
    }
    if (typeof textArray[2] !== 'undefined') {
        if (textArray[0] != textArray[2]) {
            ctx.fillText(textArray[2], x, y+32);
        }
    }
}

function langSel(l) {
    ctx.fillStyle = "Green";
    switch (l) {
        case 1:
            lang = "EN";
            wrapLen = 28;
            ctx.font = "30px SQ3font";
            break;
        case 2:
            lang = "SP";
            wrapLen = 35;
            ctx.font = "16px arial";
            break;
        case 3:
            lang = "FR";
            wrapLen = 35;
            ctx.font = "16px arial";
            break;
        case 4:
            lang = "GR";
            wrapLen = 35;
            ctx.font = "16px arial";
            break;
        case 5:
            lang = "PL";
            wrapLen = 35;
            ctx.font = "16px arial";
            break;
        default:
    }

    nextQuestion();

    // indicate langague has changed
    ctx.fillStyle = "Black";
    let str;
    switch (l) {
        case 1:
            str = "English";
            break;
        case 2:
            str = "Espa\u00f1ol";
            break;
        case 3:
            str = "Fran\u00e7ais";
            break;
        case 4:
            str = "Deutsch";
            break;
        case 5:
            str = "Polski";
            break;
        default:
    }
    printText(str,350,450);
}

function switchLSLorOpenTrivia() { // REDO
    if (langLock == 0) {
        if (qType == 2) {
            qType = 1;
        } else {
            qType = 2;
        }
    }
    nextQuestion();
    if (langLock == 0) {
        if (qType == 1) {
            if (lang == "SP") {
                printText("Preguntas sobre LSL3",350,400);
            } else if (lang == "EN") {
                printText("LSL3 questions",350,400);
            }
        } else {
            printText("Open Trivia questions",350,400);
            printText("English only :(",350,420);
        }
        langLock = 1;
    }
}

function wrapText(text, maxWidth) {

    if (text.length >= maxWidth) {
        let i = maxWidth;
        let x;
        while (text.charAt(i) != " ") {
            //console.log("text.charAt(maxWidth): " + text.charAt(maxWidth));
            i --;
            x = i;
        }
        //console.log("Space found at: " + x);
        let pre = text.slice(0, x);
        let post = text.slice(x+1);
        text = pre + "\n" + post;
        if (text.length > maxWidth*2) {
            for (let i=maxWidth*2; text[i] == " "; i--) {
                text[i].replace(" ", "\n");
            }
        }
    }
    return text
}

</script>

<br>
<button type="button" class="butt" onclick="langSel(1)">English</button>
<button type="button" class="butt" onclick="langSel(2)">Espa&#x00F1ol</button>
<button type="button" class="butt" onclick="langSel(3)">Fran&#231ais</button>
<button type="button" class="butt" onclick="langSel(4)">Deutsch</button>
<button type="button" class="butt" onclick="langSel(5)">Polski</button>
<!--button type="button" class="butt" onclick="switchLSLorOpenTrivia()">lsl3/OpenTrivia</button-->
<button type="button" class="butt" onclick="musicOnOff()">Music On/Off</button>
</body>
</html>
